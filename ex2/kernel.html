<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>构建内核 - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="about.html"><strong>1.</strong> 关于本文档</a></li><li><a href="information.html"><strong>2.</strong> 课程信息</a></li><li><ul class="section"><li><a href="introduction.html"><strong>2.1.</strong> 实验介绍</a></li><li><a href="commit.html"><strong>2.2.</strong> 作业提交说明</a></li><li><a href="resources.html"><strong>2.3.</strong> 课程资料</a></li><li><a href="contact.html"><strong>2.4.</strong> 联系助教</a></li></ul></li><li><a href="ex1/index.html"><strong>3.</strong> 实验一</a></li><li><ul class="section"><li><a href="ex1/index.html"><strong>3.1.</strong> 实验内容</a></li><li><ul class="section"><li><a href="ex1/linux_install.html"><strong>3.1.1.</strong> 安装Linux操作系统</a></li><li><a href="ex1/linux_command.html"><strong>3.1.2.</strong> 熟悉Linux操作系统的常用命令</a></li><li><a href="ex1/bash.html"><strong>3.1.3.</strong> 学习使用bash</a></li><li><a href="ex1/git.html"><strong>3.1.4.</strong> 学习使用Git</a></li><li><a href="ex1/github.html"><strong>3.1.5.</strong> 熟悉GitHub的使用流程</a></li></ul></li><li><a href="ex1/commit.html"><strong>3.2.</strong> 作业提交</a></li><li><a href="ex1/score.html"><strong>3.3.</strong> 评分规则</a></li></ul></li><li><a href="ex2/index.html"><strong>4.</strong> 实验二</a></li><li><ul class="section"><li><a href="ex2/index.html"><strong>4.1.</strong> 实验内容</a></li><li><ul class="section"><li><a href="ex2/before-reading.html"><strong>4.1.1.</strong> 写在前面</a></li><li><a href="ex2/environment.html"><strong>4.1.2.</strong> 准备环境</a></li><li><a href="ex2/kernel.html" class="active"><strong>4.1.3.</strong> 构建内核</a></li><li><a href="ex2/busybox.html"><strong>4.1.4.</strong> 构建busybox</a></li><li><a href="ex2/rootfs.html"><strong>4.1.5.</strong> 完善根文件系统</a></li><li><a href="ex2/run.html"><strong>4.1.6.</strong> 运行操作系统</a></li><li><a href="ex2/after-reading.html"><strong>4.1.7.</strong> 写在后面</a></li></ul></li><li><a href="ex2/commit.html"><strong>4.2.</strong> 作业提交</a></li><li><a href="ex2/score.html"><strong>4.3.</strong> 评分规则</a></li></ul></li><li><a href="ex3/index.html"><strong>5.</strong> 实验三</a></li><li><ul class="section"><li><a href="ex3/index.html"><strong>5.1.</strong> 实验内容</a></li><li><a href="ex3/commit.html"><strong>5.2.</strong> 作业提交</a></li></ul></li><li><a href="ex4/index.html"><strong>6.</strong> 实验四</a></li><li><ul class="section"><li><a href="ex4/index.html"><strong>6.1.</strong> 实验内容</a></li><li><ul class="section"><li><a href="ex4/kernel.html"><strong>6.1.1.</strong> 编译目标内核</a></li><li><a href="ex4/qemu.html"><strong>6.1.2.</strong> 使用QEMU测试内核</a></li><li><a href="ex4/introduce.html"><strong>6.1.3.</strong> 漏洞介绍</a></li></ul></li><li><a href="ex4/commit.html"><strong>6.2.</strong> 作业提交</a></li></ul></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="ex2/kernel.html#构建内核" id="构建内核"><h1>构建内核</h1></a>
<p>本小节主要阐述如何从源代码构建一个最小化的Linux内核，了解必要的内核编译选项。</p>
<a class="header" href="ex2/kernel.html#获取内核源码" id="获取内核源码"><h2>获取内核源码</h2></a>
<p>下载Linux内核源代码：</p>
<pre><code># cd /usr/local/src
# curl https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.10.7.tar.xz | tar xJf -
# cd /usr/local/src/linux-4.10.7
</code></pre>
<p>P.S. <code>curl</code>是一个多协议的网络通讯工具。在上一条命令中，<code>curl</code>从互联网获取内核源码的压缩包，并借助管道(pipe)将数据提供给文件存档工具<code>tar</code>，<code>tar</code>将<code>curl</code>获取的数据解压到当前目录中。 参数中<code>x</code>表示解压，<code>J</code>表示解压xz格式的数据，<code>f</code>表示指定输入文件，<code>-</code>表示使用标准输入作为输入文件。</p>
<p>本文撰写时，Linux内核最新的稳定版本为4.10.7，为了避免内核版本不同带来的配置差异，建议大家统一使用<code>4.10.x</code>系列的内核。</p>
<a class="header" href="ex2/kernel.html#编译" id="编译"><h2>编译</h2></a>
<a class="header" href="ex2/kernel.html#生成初始配置" id="生成初始配置"><h3>生成初始配置</h3></a>
<p>生成一个空的配置文件：</p>
<pre><code># make allnoconfig
</code></pre>
<a class="header" href="ex2/kernel.html#修改内核配置" id="修改内核配置"><h3>修改内核配置</h3></a>
<p>启动配置（编辑）器：</p>
<pre><code># make menuconfig
</code></pre>
<p><strong>说明：方向键可以移动光标，空格键用于选中（或取消选中）当前选项，ESC键返回上层菜单（或退出），按下高亮的字母可以快速跳转至对应选项。</strong></p>
<p>打开64位内核支持：</p>
<pre><code>[*] 64-bit kernel
</code></pre>
<p>为了让内核能够打印调试信息，我们需要打开kernel print function的支持：</p>
<pre><code>-&gt; General setup
  -&gt; Configure standard kernel features
[*] Enable support for printk
</code></pre>
<p>打开内存文件系统的支持：</p>
<pre><code>-&gt; General setup
[*] Initial RAM filesystem and RAM disk (initramfs/initrd) support
</code></pre>
<p>打开ELF可执行文件和<code>#!</code>类脚本文件的支持：</p>
<pre><code>-&gt; Executable file formats / Emulations
[*] Kernel support for ELF binaries
[*] Kernel support for scripts starting with #!
</code></pre>
<p>打开TTY驱动的支持：</p>
<pre><code>-&gt; Device Drivers
  -&gt; Character devices
[*] Enable TTY
</code></pre>
<p>为了能让QEMU能正常显示终端，需要打开UART串口的支持：</p>
<pre><code>-&gt; Device Drivers
  -&gt; Character devices
    -&gt; Serial drivers
[*] 8250/16550 and compatible serial support
[*]   Console on 8250/16550 and compatible serial port
</code></pre>
<p>为了让标准UNIX工具能够正常工作（如获取启动时间），需要打开<code>/proc</code>和<code>sysfs</code>文件系统的支持：</p>
<pre><code>-&gt; File systems
  -&gt; Pseudo filesystems
[*] /proc file system support
[*] sysfs file system support
</code></pre>
<p>全部设置完成后，请保存修改后退出配置编辑器。</p>
<a class="header" href="ex2/kernel.html#编译-1" id="编译-1"><h3>编译</h3></a>
<p>开始编译内核：</p>
<pre><code># make
</code></pre>
<p>将编译的结果复制到<code>/usr/local/mini-os</code>目录备用：</p>
<pre><code># mkdir -pv /usr/local/mini-os
# cp arch/x86_64/boot/bzImage /usr/local/mini-os/bzImage
</code></pre>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="ex2/environment.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="ex2/busybox.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="ex2/environment.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="ex2/busybox.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
